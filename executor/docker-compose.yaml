# DNAT Executor Stack (runs on VM)
#
# This docker-compose runs:
# - Hardhat (local blockchain)
# - IPFS node (stores encrypted data)
# - Executor API (receives execution requests)
# - LAS (SCONE Local Attestation Service)
#
# Access from local machine via SSH tunnel:
#   ssh -L 8080:localhost:8080 -L 5001:localhost:5001 -L 8081:localhost:8081 -L 8545:localhost:8545 user@vm

services:
  # ===========================================
  # Hardhat - Local Blockchain
  # ===========================================
  hardhat:
    image: node:20.19.5
    container_name: dnat-hardhat
    working_dir: /app
    volumes:
      - ../smart-contract:/app
    ports:
      - "8545:8545"
    command: ["sh", "-c", "npm install && npx hardhat node --hostname 0.0.0.0"]

  # ===========================================
  # IPFS - Stores encrypted datasets and apps
  # ===========================================
  ipfs:
    image: ipfs/kubo:latest
    container_name: dnat-ipfs
    ports:
      - "4001:4001"      # Swarm (P2P)
      - "5001:5001"      # API
      - "8080:8080"      # Gateway
    volumes:
      - ipfs_data:/data/ipfs
    environment:
      - IPFS_PROFILE=server

  # ===========================================
  # Executor API - Receives execution requests
  # ===========================================
  api:
    build: ./api
    container_name: dnat-executor-api
    ports:
      - "8081:8081"
    environment:
      PORT: "8081"
      DEBUG: "true"
      BLOCKCHAIN_RPC: "http://hardhat:8545"
      CONTRACT_ADDRESS: "${CONTRACT_ADDRESS:-0x5FbDB2315678afecb367f032d93F642f64180aa3}"
      IPFS_GATEWAY: "http://ipfs:8080/ipfs"
      ENCLAVE_IMAGE: "dnat-enclave"
      CAS_URL: "scone-cas.cf"
      SCONE_CONFIG_ID: "${SCONE_CONFIG_ID:-}"
    volumes:
      - ./api/enclave:/app/enclave
      - ./certs:/app/certs:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - /tmp:/tmp
    depends_on:
      - ipfs
      - hardhat
      - las
      - enclave

  # ===========================================
  # SCONE LAS - Local Attestation Service
  # ===========================================
  las:
    image: registry.scontain.com/sconecuratedimages/las
    container_name: dnat-las
    user: root
    devices:
      - "/dev/sgx_enclave:/dev/sgx_enclave"
      - "/dev/sgx_provision:/dev/sgx_provision"
    ports:
      - "18766:18766"

  # ===========================================
  # Enclave - SGX execution environment
  # ===========================================
  enclave:
    build: ./enclave
    image: dnat-enclave
    container_name: dnat-enclave-build
    command: echo "Enclave image built"
    # This service just builds the image; actual execution is via docker run

volumes:
  ipfs_data:

